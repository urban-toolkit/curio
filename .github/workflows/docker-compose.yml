name: Full stack build

on:
  push:
    branches:
      - main
      - karla
    paths:
      - 'utk_curio/**'
      - 'Dockerfile'
      - '.github/workflows/docker-compose.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'utk_curio/**'
      - 'Dockerfile'
      - '.github/workflows/docker-compose.yml'
  # workflow_dispatch:  # Run manually from Actions tab or: gh workflow run docker-compose.yml

jobs:
  test-compose:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üî® Build all service images in parallel
        run: docker compose -p curio build --parallel

      - name: ‚ñ∂Ô∏è Start containers
        run: docker compose -p curio up -d

      - name: üß™ Wait for services to become healthy
        shell: bash
        run: |
          set -euo pipefail
          echo "Waiting for curio to be healthy..."

          timeout 240 bash -euo pipefail -c '
            while true; do
              cid="$(docker compose -p curio ps -a -q curio | head -n1 || true)"

              if [[ -z "${cid}" ]]; then
                echo "Still waiting... (curio container not created yet)"
                docker compose -p curio ps -a || true
                sleep 2
                continue
              fi

              state="$(docker inspect --format "{{.State.Status}}" "${cid}" 2>/dev/null || true)"
              health="$(docker inspect --format "{{if .State.Health}}{{.State.Health.Status}}{{else}}no-healthcheck{{end}}" "${cid}" 2>/dev/null || true)"

              if [[ "${health}" == "healthy" ]]; then
                echo "curio is healthy."
                break
              fi

              # If there is no Docker HEALTHCHECK, accept "running"
              if [[ "${health}" == "no-healthcheck" && "${state}" == "running" ]]; then
                echo "curio is running (no healthcheck)."
                break
              fi

              # If it crashed, fail fast with logs
              if [[ "${state}" == "exited" ]]; then
                echo "curio exited. Logs:"
                docker compose -p curio logs --no-color --tail=200 curio || true
                exit 1
              fi

              echo "Still waiting... (state=${state:-unknown}, health=${health:-unknown})"
              sleep 2
            done
          '

      - name: üß™ Run backend unit tests
        run: |
          docker compose -p curio exec curio \
            python -m unittest discover -s utk_curio/backend/tests -t . -p "test_*.py" -v

      - name: üß™ Run sandbox unit tests
        run: |
          docker compose -p curio exec curio \
            python -m unittest discover -s utk_curio/sandbox/tests -t . -p "test_*.py" -v

      - name: üåê Check frontend availability
        run: |
          curl --fail http://localhost:8080 || (echo "Frontend not reachable" && exit 1)

      - name: üêç Set up Python (for e2e)
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: üé≠ Install Playwright and run e2e tests
        run: |
          pip install -r requirements.txt
          python -m playwright install chromium
          cd utk_curio/backend
          CURIO_E2E_USE_EXISTING=1 PYTHONPATH="$GITHUB_WORKSPACE" python -m pytest tests/test_frontend/test_alive.py -v

      - name: üßπ Tear down containers
        run: docker compose -p curio down
