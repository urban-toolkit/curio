name: Full stack build

on:
  push:
    branches:
      - main
    paths:
      - 'utk_curio/**'
      - '.github/workflows/docker-compose.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'utk_curio/**'
      - '.github/workflows/docker-compose.yml'
  workflow_dispatch:  # Run manually from Actions tab or: gh workflow run docker-compose.yml

jobs:
  test-compose:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ”¨ Build all service images in parallel
        run: docker compose -p curio build --parallel

      - name: â–¶ï¸ Start containers
        run: docker compose -p curio up -d

      - name: ğŸ§ª Wait for services to become healthy
        run: |
          echo "Waiting for container to become healthy..."
          CONTAINER_ID=$(docker compose -p curio ps -q curio)
          if [ -z "$CONTAINER_ID" ]; then
            echo "Container not found. docker compose -p curio ps -a:"
            docker compose -p curio ps -a
            exit 1
          fi
          export CONTAINER_ID
          # HEALTHCHECK has 120s start-period; allow 180s total for status to become healthy
          timeout 180 bash -c '
            until status=$(docker inspect -f "{{.State.Health.Status}}" "$CONTAINER_ID" 2>/dev/null) && [ "$status" = "healthy" ]; do
              echo "Still waiting (status=${status:-unknown})..."
              sleep 3
            done
          ' || { echo "Container did not become healthy within 180s."; docker compose -p curio ps -a; docker inspect "$CONTAINER_ID" --format "{{json .State.Health}}" 2>/dev/null || true; exit 1; }
          echo "Services are healthy."

      - name: ğŸ§ª Run backend unit tests
        run: |
          docker compose -p curio exec curio \
            python -m unittest discover -s utk_curio/backend/tests -t . -p "test_*.py" -v

      - name: ğŸ§ª Run sandbox unit tests
        run: |
          docker compose -p curio exec curio \
            python -m unittest discover -s utk_curio/sandbox/tests -t . -p "test_*.py" -v

      - name: ğŸŒ Check frontend availability
        run: |
          curl --fail http://localhost:8080 || (echo "Frontend not reachable" && exit 1)

      - name: ğŸ Set up Python (for e2e)
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ­ Install Playwright and run e2e tests
        run: |
          pip install -r requirements.txt
          python -m playwright install chromium
          cd utk_curio/backend
          CURIO_E2E_USE_EXISTING=1 PYTHONPATH="$GITHUB_WORKSPACE" python -m pytest tests/test_frontend/test_alive.py -v

      - name: ğŸ§¹ Tear down containers
        run: docker compose -p curio down
